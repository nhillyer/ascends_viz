\documentclass[12pt]{article}

\usepackage{palatino}
\usepackage{amsmath}

% Idiopidae
\usepackage{fancybox}
\usepackage[]{geometry}
\usepackage{fancyvrb}
\usepackage{color}
\include{styles/emacs}
\include{commands}

\begin{document}
\author{Benjamin S. Hughes}
\title{Confessions of the ASCENDS Data Visualization Team}
\maketitle

This document attempts to justify and explain the methods to our madness.  In this tome, the structure and interpretation of the data we have been given shall be divined and documented.  The mathematical incantations will be demystified.  Basically, this document will change your life.

\section*{Data}

The data we received came in two categories: insitu and ITT.  The insitu data are the mixing ratio (in ppm) as recorded at the altitude of the airplane. The ITT data are the value of the backscatter of a laser that is absorbed by CO$_2$. This value can then be used to calculate the number density of CO$_2$ in the column of air below the laser.  The ITT data are the primary focus of the experiment.

The data are organized into flights (which makes sense because that is how the data are gathered).  Flights are named as \texttt{\%m\%d\%y\_flightN/} where \texttt{N} is the flight number.  In the original file structure there are the folders \texttt{insitu/\%m\%d\%y\_flightN/} and \texttt{itt/\%m\%d\%y\_flightN/}; for processing, we change the directory structure to \texttt{\%m\%d\%y\_flightN/insitu/} and \texttt{\%m\%d\%y\_flightN/itt/}.

\subsection*{Insitu}

The insitu data are in CSV files. The CO$_2$ readings are found in the files \texttt{lear*.txt}.  The first column seems to be nonsensical and a constant 999.  The second column is seconds since midnight (in localtime/EDT).  The third column is the mixing ration (parts per million) of CO$_2$ at the altitude the plane was flying.

\subsection*{ITT}

The ITT data are spread over a variety of files and formats.  The two that are of interest are the files that contain the CO$_2$ readings which match the pattern \texttt{*.dbl} and the GPS information which is contained in the file \texttt{*in-situ\_gps\_serial \_data.txt}.

The CO$_2$ readings are stored as a binary file of 8-byte floating point values (doubles) in little endian form.  The first value is the number of seconds since January 1, 1904 00:00 GMT \footnote{Yes, it is different from the UNIX epoch of 1970-01-01 00:00 GMT, conversion code is necessary}. Measurements are taken at 5Hz. The format is given in the table:

\begin{center}
\begin{tabular}{|l|l|l|l|l|l|l|l|l|}
\hline 
Time & Ref\_On & Ref\_Side & Ref\_Off & Blank & Sci\_On & Sci\_Side & Sci\_Off & Blank \\
\hline
\end{tabular}
\end{center}

The GPS positions are in a CSV file.  The timestamp is the first two elements on a line and is in the form \texttt{\%m/\%d/\%Y \%H:\%M:\%S}.  The longitude and latitude are stored in elements nine through twelve.  They are stored as hemisphere character and then an integer.  \texttt{DataPoint::make\_lat\_lon} converts them to floating points by splitting up the string of the number and converting into degrees, minutes, and seconds. The longitude value seems to have an extraneous 0 prepended that is removed during processing.

During the import phase, all values are combined and averaged for each second.  This allows the GPS and CO$_2$ data to be merged easily.

ITT CO$_2$ data is taken from the side sensor and is stored as the ratio of Sci\_Side and Ref\_Side.  

\section*{Visualizations}

\subsection*{Geographic Geometry}

The visualizations work because of maths.  Maths is the study of numbers.  The earth is a sphere\footnote{No, it actually isn't, but in our world it is}.  For these visualizations, we use spherical trigonometry to find latitude and longitude coordinates.  We have encapsulated many common operations into \texttt{KmlTools}.

Often it is necessary to find the heading (clockwise angle originating from North) between two points.  This can be found with the following process.

\begin{equation}
\begin{aligned}
A &=\Delta \lambda \\
c &=90^\circ - \phi_2 \\
b &=90^\circ - \phi_1 \\
\end{aligned}
\end{equation}

\begin{equation}
a = \arccos{(\cos{b}\cos{c} + \sin{b}\sin{c}\cos{A})}
\end{equation}

\begin{equation}
C =\arcsin{\left( \frac{\sin{A}\sin{c}}{\sin{a}} \right)}
\end{equation}

\begin{equation}
B = 180^\circ - (A + C)
\end{equation}

\begin{equation}
h(x) = \begin{cases}
  360^\circ - C, & \phi_1<\phi_2 \\
  180^\circ - C, & \phi_1>\phi_2 \\
\end{cases}
\end{equation}

It is also useful to be able to find the distance between two points.  This can be found using an adaptation of the Haversine Formula.

\begin{equation}
\text{Earth}_\text{radius}\cdot 2\arcsin\left(\sin^2{\left(\frac{\Delta \phi}{2}\right)} + \cos(\phi_1)\cos(\phi_2)\sin^2\left(\frac{\Delta \lambda}{2}\right)\right)
\end{equation}

Going in the opposite direction, coordinates of the form ($\phi_2$,$\lambda_2$) can be found at a distance $d$ and an angle (heading) $h$ by:


\begin{equation}
\label{great-circle-coords-lat}
\phi_2 = \arcsin(\sin\phi_1\cos{d}+\cos\phi_1\sin d\cos(h))
\end{equation}

\begin{equation}
\label{great-circle-coords-dlon}
\Delta\lambda = \arctan\left(\frac{\sin(h)\sin d\cos\phi_1}{\cos d-\sin\phi_1\sin\phi_2}\right)
\end{equation}

\begin{equation}
\lambda_2 = \left((\lambda_1+\Delta\lambda+\pi) \mod 2\pi\right)-\pi
\end{equation}

Equation (\ref{great-circle-coords-lat}) is derived from the spherical law of cosines

\begin{equation}
\cos{b} =\cos{c}\cos{a} + \sin c\sin a\cos B
\end{equation}

where $a=\frac{\pi}{2}-\phi_1$, $b=\frac{\pi}{2}-\phi_2$, $c=d$, and $B=h$.  The derivation of Equation (\ref{great-circle-coords-dlon}) is much more involved and beyond the scope of this document.

\texttt{KmlTools} also contains applications of these formul\ae for the drawing of shapes.  These shape functions often come in two forms, \textit{shape}() and \textit{shape}\texttt{\_coords}().  The \texttt{\_coords} function just generates the \texttt{[lon,lat,alt]} coordinates, while the undecorated name wraps the coordinates into a \texttt{KML::Polygon}.

\subsection*{lisp.rb}

Due to personal preference, I have included a small library file called \texttt{lisp.rb}.  It includes the functions \texttt{car} and \texttt{cdr}.  They both take a single argument, an array.  \texttt{car} returns the first element of the array (the head) and \texttt{cdr} returns all the elements after the first (the tail).  The appearance of these functions throughout the code might be unsettling at first, but they are truly helpful to me.

\subsection*{Tasks}





\end{document}
